# dev
services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: books-api:dev
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Default: "Data Source=/app/db/app.db"
    volumes:
      - data_dev:/app/db
    ports:
      - "${API_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: "512M"
    logging:
      driver: fluentd
      options:
        fluentd-address: "fluentbit:${FLUENTD_PORT:-24224}"
        tag: "${FLUENTD_TAG:-books-api.dev}"
        max-size: "10m"
        max-file: "3"

  fluentbit:
    image: amazon/aws-for-fluent-bit:latest
    ports:
      - "${FLUENTD_PORT:-24224}:24224"
    volumes:
      - ./log-collector/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./log-collector/parsers.conf:/fluent-bit/etc/parsers.conf
      - fluentbit_buffer:/fluent-bit/buffer
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2020/api/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"

volumes:
  data_dev:
  fluentbit_buffer:
