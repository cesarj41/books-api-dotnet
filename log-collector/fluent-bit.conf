# ============================
# Fluent Bit
# AWS CloudWatch Logs Optimized
# ============================

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

[INPUT]
    Name          forward
    Listen        0.0.0.0
    Port          24224
    Buffer_Max_Size   64MB

[FILTER]
    Name          modify
    Match         *
    Add           hostname ${HOSTNAME}
    Add           environment ${ENVIRONMENT:-production}

[STORAGE]
    Type              filesystem
    Path              /fluent-bit/buffer
    Sync              normal
    Checksum          Off
    Backlog_Mem_Limit 64MB

[OUTPUT]
    Name                   cloudwatch_logs
    Match                  *
    region                 ${AWS_REGION:-us-east-1}
    log_group_name         ${CLOUDWATCH_LOG_GROUP:-books-api}
    log_stream_name         ${CLOUDWATCH_LOG_STREAM:-books-api-${HOSTNAME}}
    auto_create_group      ${CLOUDWATCH_AUTO_CREATE_GROUP:-true}
    auto_create_stream     ${CLOUDWATCH_AUTO_CREATE_STREAM:-true}
    log_retention_days     ${CLOUDWATCH_LOG_RETENTION_DAYS:-30}
    auto_retry_requests    true
    storage.total_limit_size  512MB
    Retry_Limit            False
    # Batch settings for better performance
    log_key                log
    log_format             json/emf
    # Credentials via IAM role (recommended) or environment variables
    # AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are read from environment